<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Document Manifest Viewer</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:-apple-system,BlinkMacSystemFont,'SF Pro Rounded','SF Pro Display',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
            background:#001122; color:#fff; min-height:100vh; padding:28px; display:flex; flex-direction:column; gap:28px; align-items:center;
        }
        .shell { width:100%; max-width:1200px; display:flex; flex-direction:column; gap:26px; }
        .panel { background:#333; border-radius:20px; padding:28px 32px; box-shadow:0 18px 50px rgba(0,0,0,.5); }
        h1 { font-size:2.2rem; font-weight:500; text-shadow:0 4px 8px rgba(0,0,0,.5); margin:0 0 8px; }
        p.sub { font-size:.8rem; color:#ccc; font-style:italic; line-height:1.5; }
        a { color:#87CEFA; text-decoration:none; }
        a:hover { text-decoration:underline; }
        form.query { display:flex; flex-wrap:wrap; gap:14px; align-items:flex-end; }
        form.query > div { display:flex; flex-direction:column; gap:6px; }
        label { font-size:.7rem; text-transform:uppercase; letter-spacing:1px; color:#ccc; }
        input[type="number"], input[type="text"] { background:#222; border:2px solid #555; border-radius:10px; padding:10px 14px; color:#fff; font-family:inherit; min-width:140px; }
        input:focus { outline:none; border-color:#7ec8ff; box-shadow:0 0 0 3px rgba(126,200,255,0.15); }
        button { background:#7ec8ff; color:#001122; border:none; padding:12px 22px; border-radius:10px; font-weight:600; cursor:pointer; font-size:.9rem; letter-spacing:1px; transition:.25s; box-shadow:0 8px 18px rgba(126,200,255,0.25); }
        button:hover { background:#6bb8ff; transform:translateY(-2px); }
        button:active { transform:translateY(0); }
        button.secondary { background:rgba(255,102,102,.45); color:#fff; box-shadow:none; }
        button.secondary:hover { background:rgba(255,102,102,.6); }
        .status { font-size:.75rem; color:#ccc; margin-top:6px; min-height:18px; }
    .results { display:flex; flex-direction:column; gap:22px; }
    .view-toggles { display:flex; gap:10px; flex-wrap:wrap; }
    .view-toggles button { background:#2d3f4d; color:#cfe9ff; box-shadow:none; padding:8px 14px; font-size:.7rem; }
    .view-toggles button.active { background:#7ec8ff; color:#001122; }
        .meta-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:14px; }
        .kv { background:#222; border:2px solid #555; border-radius:12px; padding:12px 14px; display:flex; flex-direction:column; gap:4px; }
        .kv span.k { font-size:.65rem; text-transform:uppercase; letter-spacing:1px; color:#999; }
        .kv span.v { font-size:.85rem; word-break:break-word; }
    .records { background:#222; border:2px solid #555; border-radius:16px; padding:20px; display:flex; flex-direction:column; gap:20px; max-height:50vh; overflow:auto; }
    .table-wrapper { background:#222; border:2px solid #555; border-radius:16px; padding:14px 18px; max-height:55vh; overflow:auto; }
    table.data-table { width:100%; border-collapse:collapse; font-size:.7rem; }
    table.data-table th, table.data-table td { padding:6px 8px; text-align:left; border:1px solid #444; vertical-align:top; }
    table.data-table th { position:sticky; top:0; background:#2d3f4d; z-index:2; font-weight:600; letter-spacing:.5px; }
    table.data-table tbody tr:nth-child(even){ background:#1e2a33; }
    .truncate { max-width:300px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .row-expand { cursor:pointer; color:#87CEFA; font-size:.6rem; }
        .record { background:#1b2733; border:1px solid #3d4c55; border-radius:12px; padding:16px 18px; display:flex; flex-direction:column; gap:10px; position:relative; }
        .record h3 { margin:0; font-size:.95rem; font-weight:600; }
        .badge-row { display:flex; flex-wrap:wrap; gap:6px; }
        .badge { background:#2d3f4d; color:#cfe9ff; font-size:.6rem; padding:4px 8px; border-radius:100px; letter-spacing:.5px; text-transform:uppercase; }
        .json-view { font-family:Consolas,Monaco,monospace; font-size:.7rem; background:#111a22; border:1px solid #2c3a44; border-radius:8px; padding:10px 12px; white-space:pre; overflow:auto; max-height:240px; }
        .empty { text-align:center; font-style:italic; color:#ccc; }
        .error { color:#ff7b7b; font-weight:600; }
        .spinner { width:18px; height:18px; border:3px solid rgba(255,255,255,.2); border-top-color:#7ec8ff; border-radius:50%; animation:spin 1s linear infinite; }
        .inline { display:inline-flex; align-items:center; gap:10px; }
        @keyframes spin { to { transform:rotate(360deg);} }
        .toolbar { display:flex; gap:10px; flex-wrap:wrap; }
        .filter-box { background:#222; border:2px solid #555; border-radius:10px; padding:8px 12px; display:flex; gap:10px; }
        .filter-box input { border:none; background:transparent; padding:0; font-size:.75rem; min-width:160px; }
        .filter-box input:focus { outline:none; }
        .copy-btn { position:absolute; top:10px; right:10px; font-size:.55rem; padding:4px 8px; background:#2d3f4d; color:#fff; border:none; border-radius:6px; cursor:pointer; }
        .copy-btn:hover { background:#3d5566; }
        @media (max-width:800px){ .panel { padding:22px 20px; } h1 { font-size:1.7rem; } }
        .pagination { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:12px; font-size:.65rem; }
        .pagination button { padding:6px 10px; font-size:.65rem; background:#2d3f4d; color:#cfe9ff; box-shadow:none; }
        .pagination button:disabled { opacity:.35; cursor:not-allowed; }
        th.sortable { cursor:pointer; user-select:none; }
        th.sortable:hover { background:#355064; }
        th.sortable .indicator { font-size:.55rem; margin-left:4px; opacity:.8; }
    tr.editing { background:#283745 !important; }
    td.editable { cursor:text; }
    td.editable:hover { background:#203240; }
    .row-actions { display:flex; gap:6px; }
    .row-actions button { padding:4px 10px; font-size:.6rem; background:#355064; color:#cfe9ff; }
    .row-actions button.confirm { background:#4caf50; color:#fff; }
    .row-actions button.cancel { background:#d9534f; color:#fff; }
    </style>
</head>
<body>
    <div class="shell">
        <div class="panel">
            <h1>Global Manifest</h1>
            <p class="sub">Viewing combined <code>manifest/manifest.jsonl</code> from bucket <code>tx-rag-corpus</code>. Columns represent extracted / enriched metadata for all documents. Client-side filter works across all loaded rows.</p>
            <form id="filterForm" class="query" autocomplete="off" style="margin-bottom:10px;">
                <div>
                    <label for="filter">Text Filter</label>
                    <input type="text" id="filter" placeholder="Type to filter rows" />
                </div>
                <div style="display:flex; gap:8px;">
                    <button type="button" id="refreshBtn">Refresh</button>
                    <button type="button" class="secondary" id="clearBtn">Clear</button>
                </div>
            </form>
            <div class="status" id="status"></div>
        </div>
        <div class="panel" id="manifestPanel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px;flex-wrap:wrap;">
                <h2 style="font-size:1.2rem;margin:0;">Manifest Entries</h2>
                <div style="font-size:.65rem;letter-spacing:1px;color:#ccc;">Total: <span id="rowCount">0</span></div>
            </div>
            <div class="table-wrapper" id="manifestTableWrapper"></div>
                <div class="pagination" id="pagination" style="display:none;">
                    <button id="firstPage" title="First">⏮</button>
                    <button id="prevPage" title="Previous">◀</button>
                    <span>Page <span id="pageNum">1</span> / <span id="pageCount">1</span></span>
                    <button id="nextPage" title="Next">▶</button>
                    <button id="lastPage" title="Last">⏭</button>
                    <span>| Rows: <span id="visibleCount">0</span> / <span id="totalCount">0</span></span>
                </div>
        </div>
    </div>

    <script>
        const filterForm = document.getElementById('filterForm');
        const filterInput = document.getElementById('filter');
        const statusEl = document.getElementById('status');
        const refreshBtn = document.getElementById('refreshBtn');
        const clearBtn = document.getElementById('clearBtn');
        const manifestTableWrapper = document.getElementById('manifestTableWrapper');
        const rowCountEl = document.getElementById('rowCount');
        let manifestRows = [];
        const PAGE_SIZE = 25;
        let currentPage = 1;
        let sortCol = 'doc_id';
        let sortDir = 'asc'; // 'asc' | 'desc'

        // Pagination elements
        const paginationEl = document.getElementById('pagination');
        const firstPageBtn = document.getElementById('firstPage');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const lastPageBtn = document.getElementById('lastPage');
        const pageNumEl = document.getElementById('pageNum');
        const pageCountEl = document.getElementById('pageCount');
        const visibleCountEl = document.getElementById('visibleCount');
        const totalCountEl = document.getElementById('totalCount');

        function esc(v){
            return String(v ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        }

        function setStatus(msg, isError=false){
            statusEl.innerHTML = msg ? `<span class="${isError?'error':''}">${esc(msg)}</span>` : '';
        }

        function spinner(){
            setStatus(`<span class='inline'><span class='spinner'></span> Loading...</span>`);
        }

        function buildMetaCard(k, v){
            return `<div class="kv"><span class="k">${esc(k)}</span><span class="v">${esc(v)}</span></div>`;
        }

        function filteredRows(){
            const term = filterInput.value.trim().toLowerCase();
            if(!term) return manifestRows;
            return manifestRows.filter(r => JSON.stringify(r).toLowerCase().includes(term));
        }

            function compareValues(a, b){
                // Attempt numeric compare if both parse to numbers
                const an = parseFloat(a); const bn = parseFloat(b);
                const aNum = !isNaN(an) && String(an) === String(a).trim();
                const bNum = !isNaN(bn) && String(bn) === String(b).trim();
                if(aNum && bNum){
                    if(an < bn) return -1; if(an > bn) return 1; return 0;
                }
                const as = String(a).toLowerCase();
                const bs = String(b).toLowerCase();
                if(as < bs) return -1; if(as > bs) return 1; return 0;
            }

            function sortRows(rows){
                if(!sortCol) return rows;
                return [...rows].sort((r1, r2) => {
                    const v1 = r1[sortCol] ?? '';
                    const v2 = r2[sortCol] ?? '';
                    const cmp = compareValues(v1, v2);
                    return sortDir === 'asc' ? cmp : -cmp;
                });
            }

            function setSort(col){
                if(sortCol === col){
                    sortDir = sortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    sortCol = col;
                    sortDir = 'asc';
                }
                currentPage = 1;
                renderTable();
            }

            function buildHeader(cols){
                return cols.map(c => {
                    const active = c === sortCol;
                    const indicator = active ? (sortDir === 'asc' ? '▲' : '▼') : '';
                    return `<th class="sortable" data-col="${esc(c)}">${esc(c)}<span class="indicator">${indicator}</span></th>`;
                }).join('');
            }

            function paginate(rows){
                const pageCount = Math.max(1, Math.ceil(rows.length / PAGE_SIZE));
                if(currentPage > pageCount) currentPage = pageCount;
                const start = (currentPage - 1) * PAGE_SIZE;
                const slice = rows.slice(start, start + PAGE_SIZE);
                // Update controls
                pageNumEl.textContent = String(currentPage);
                pageCountEl.textContent = String(pageCount);
                visibleCountEl.textContent = String(slice.length);
                totalCountEl.textContent = String(rows.length);
                firstPageBtn.disabled = currentPage === 1;
                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === pageCount;
                lastPageBtn.disabled = currentPage === pageCount;
                paginationEl.style.display = rows.length ? 'flex' : 'none';
                return slice;
            }

        function renderTable(){
                const rows = sortRows(filteredRows());
            rowCountEl.textContent = rows.length;
                if(!rows.length){ manifestTableWrapper.innerHTML = '<div class="empty">No entries match.</div>'; paginationEl.style.display='none'; return; }
                const cols = ["doc_id","title","doc_type","jurisdiction","governing_law","party_role","industry","effective_date","source_path"];
                const pageRows = paginate(rows);
                let html = '<table class="data-table"><thead><tr>' + buildHeader(cols) + '</tr></thead><tbody>';
                html += pageRows.map(r => {
                    const rid = esc(r.doc_id);
                    let tds = cols.map(c => {
                        let val = r[c];
                        if(val == null) val = '';
                        let full = String(val);
                        let display = full;
                        if(display.length > 160) display = display.slice(0,160)+'…';
                        const nonEditable = (c === 'doc_id' || c === 'source_path');
                        const cls = [display!==full?'truncate':'', nonEditable?'':'editable'].filter(Boolean).join(' ');
                        return `<td data-col="${esc(c)}" data-doc="${rid}" class="${cls}" title="${esc(full)}">${esc(display)}</td>`;
                    }).join('');
                    // Actions placeholder cell appended
                    return `<tr data-doc="${rid}">${tds}</tr>`;
                }).join('');
            html += '</tbody></table>';
            manifestTableWrapper.innerHTML = html;
                // Header sort handlers
                manifestTableWrapper.querySelectorAll('th.sortable').forEach(th => {
                    th.addEventListener('click', () => {
                        const col = th.getAttribute('data-col');
                        if(col) setSort(col);
                    });
                });
                attachEditing();
        }

        function fetchManifestAll(){
            spinner();
            fetch('/api/manifest')
              .then(r => r.json())
              .then(data => {
                  // Endpoint returns the parsed JSONL. Expect either array or object with manifest key.
                  if(Array.isArray(data)) manifestRows = data;
                  else if(Array.isArray(data.manifest)) manifestRows = data.manifest;
                  else manifestRows = [];
                  setStatus(manifestRows.length ? `Loaded ${manifestRows.length} entries.` : 'No manifest entries.');
                  renderTable();
              })
              .catch(err => { setStatus('Failed to load manifest: ' + err.message, true); manifestRows = []; renderTable(); });
        }

        filterInput.addEventListener('input', renderTable);
        refreshBtn.addEventListener('click', fetchManifestAll);
        clearBtn.addEventListener('click', () => { filterInput.value=''; currentPage=1; renderTable(); setStatus(''); });
        firstPageBtn.addEventListener('click', () => { currentPage = 1; renderTable(); });
        prevPageBtn.addEventListener('click', () => { if(currentPage>1){ currentPage--; renderTable(); } });
        nextPageBtn.addEventListener('click', () => { currentPage++; renderTable(); });
        lastPageBtn.addEventListener('click', () => { const rows = filteredRows(); currentPage = Math.max(1, Math.ceil(rows.length / PAGE_SIZE)); renderTable(); });

        function attachEditing(){
            manifestTableWrapper.querySelectorAll('td.editable').forEach(td => {
                td.addEventListener('click', () => beginEdit(td));
            });
        }

        function beginEdit(td){
            const tr = td.closest('tr');
            if(tr.classList.contains('editing')) return; // one edit at a time per row
            tr.classList.add('editing');
            const docId = tr.getAttribute('data-doc');
            const originalValues = {};
            tr.querySelectorAll('td').forEach(cell => {
                const col = cell.getAttribute('data-col');
                if(!col) return;
                originalValues[col] = cell.getAttribute('title') || cell.textContent || '';
            });
            tr.dataset.original = JSON.stringify(originalValues);

            // Make each editable cell an input
            tr.querySelectorAll('td.editable').forEach(cell => {
                const col = cell.getAttribute('data-col');
                const val = originalValues[col];
                cell.innerHTML = `<input type="text" style="width:100%;background:#16232d;border:1px solid #4a6578;color:#fff;font-size:.65rem;padding:4px 6px;border-radius:4px;" value="${esc(val)}" />`;
            });

            // Append action buttons row-end: we'll add a new td spanning? Simpler: insert after last cell.
            const colsCount = tr.querySelectorAll('td').length;
            const actionsTd = document.createElement('td');
            actionsTd.innerHTML = `<div class="row-actions"><button class="confirm">Save</button><button class="cancel">Cancel</button></div>`;
            tr.appendChild(actionsTd);

            actionsTd.querySelector('.confirm').addEventListener('click', () => confirmEdit(tr, docId));
            actionsTd.querySelector('.cancel').addEventListener('click', () => cancelEdit(tr));
        }

        function cancelEdit(tr){
            const orig = tr.dataset.original ? JSON.parse(tr.dataset.original) : {};
            tr.innerHTML = '';
            const cols = ["doc_id","title","doc_type","jurisdiction","governing_law","party_role","industry","effective_date","source_path"];
            cols.forEach(c => {
                const val = orig[c] ?? '';
                const nonEditable = (c === 'doc_id' || c === 'source_path');
                const display = val.length>160?val.slice(0,160)+'…':val;
                const cls = [display!==val?'truncate':'', nonEditable?'':'editable'].filter(Boolean).join(' ');
                const td = document.createElement('td');
                td.setAttribute('data-col', c);
                td.setAttribute('title', val);
                td.className = cls;
                td.textContent = display;
                tr.appendChild(td);
            });
            tr.classList.remove('editing');
            attachEditing();
        }

        function confirmEdit(tr, docId){
            const orig = tr.dataset.original ? JSON.parse(tr.dataset.original) : {};
            const updates = {};
            tr.querySelectorAll('td').forEach(cell => {
                const col = cell.getAttribute('data-col');
                if(!col || col==='doc_id' || col==='source_path') return;
                const input = cell.querySelector('input');
                if(!input) return;
                const newVal = input.value.trim();
                if(orig[col] !== newVal){
                    updates[col] = newVal;
                }
            });
            if(Object.keys(updates).length === 0){
                cancelEdit(tr);
                return;
            }
            // Persist
            setStatus('Saving…');
            fetch('/api/manifest', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ doc_id: docId, updates })
            }).then(r => r.json().then(j => ({ ok: r.ok, data: j })))
              .then(res => {
                  if(!res.ok){
                      setStatus(res.data.error || 'Save failed', true);
                      return;
                  }
                  // Update manifestRows entry
                  const rec = manifestRows.find(r => String(r.doc_id) === String(docId));
                  if(rec){ Object.entries(updates).forEach(([k,v]) => rec[k] = v); }
                  setStatus('Saved.');
                  cancelEdit(tr); // rebuild row from updated values
                  // Re-apply updates for row display
                  const rebuilt = manifestRows.find(r => String(r.doc_id) === String(docId));
                  if(rebuilt){
                      tr.querySelectorAll('td').forEach(td => {
                          const col = td.getAttribute('data-col');
                          if(!col) return;
                          const val = rebuilt[col] ?? '';
                          td.title = val;
                          td.textContent = val.length>160?val.slice(0,160)+'…':val;
                      });
                  }
              })
              .catch(err => {
                  setStatus('Save error: '+ err.message, true);
              });
        }

        // Initial load
        fetchManifestAll();
    </script>
</body>
</html>
