<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Document Manifest Viewer</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:-apple-system,BlinkMacSystemFont,'SF Pro Rounded','SF Pro Display',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
            background:#001122; color:#fff; min-height:100vh; padding:28px; display:flex; flex-direction:column; gap:28px; align-items:center;
        }
        .shell { width:100%; max-width:1200px; display:flex; flex-direction:column; gap:26px; }
        .panel { background:#333; border-radius:20px; padding:28px 32px; box-shadow:0 18px 50px rgba(0,0,0,.5); }
        h1 { font-size:2.2rem; font-weight:500; text-shadow:0 4px 8px rgba(0,0,0,.5); margin:0 0 8px; }
        p.sub { font-size:.8rem; color:#ccc; font-style:italic; line-height:1.5; }
        a { color:#87CEFA; text-decoration:none; }
        a:hover { text-decoration:underline; }
        form.query { display:flex; flex-wrap:wrap; gap:14px; align-items:flex-end; }
        form.query > div { display:flex; flex-direction:column; gap:6px; }
        label { font-size:.7rem; text-transform:uppercase; letter-spacing:1px; color:#ccc; }
        input[type="number"], input[type="text"] { background:#222; border:2px solid #555; border-radius:10px; padding:10px 14px; color:#fff; font-family:inherit; min-width:140px; }
        input:focus { outline:none; border-color:#7ec8ff; box-shadow:0 0 0 3px rgba(126,200,255,0.15); }
        button { background:#7ec8ff; color:#001122; border:none; padding:12px 22px; border-radius:10px; font-weight:600; cursor:pointer; font-size:.9rem; letter-spacing:1px; transition:.25s; box-shadow:0 8px 18px rgba(126,200,255,0.25); }
        button:hover { background:#6bb8ff; transform:translateY(-2px); }
        button:active { transform:translateY(0); }
        button.secondary { background:rgba(255,102,102,.45); color:#fff; box-shadow:none; }
        button.secondary:hover { background:rgba(255,102,102,.6); }
        .status { font-size:.75rem; color:#ccc; margin-top:6px; min-height:18px; }
    .results { display:flex; flex-direction:column; gap:22px; }
    .view-toggles { display:flex; gap:10px; flex-wrap:wrap; }
    .view-toggles button { background:#2d3f4d; color:#cfe9ff; box-shadow:none; padding:8px 14px; font-size:.7rem; }
    .view-toggles button.active { background:#7ec8ff; color:#001122; }
        .meta-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:14px; }
        .kv { background:#222; border:2px solid #555; border-radius:12px; padding:12px 14px; display:flex; flex-direction:column; gap:4px; }
        .kv span.k { font-size:.65rem; text-transform:uppercase; letter-spacing:1px; color:#999; }
        .kv span.v { font-size:.85rem; word-break:break-word; }
    .records { background:#222; border:2px solid #555; border-radius:16px; padding:20px; display:flex; flex-direction:column; gap:20px; max-height:50vh; overflow:auto; }
    .table-wrapper { background:#222; border:2px solid #555; border-radius:16px; padding:14px 18px; max-height:55vh; overflow:auto; }
    table.data-table { width:100%; border-collapse:collapse; font-size:.7rem; }
    table.data-table th, table.data-table td { padding:6px 8px; text-align:left; border:1px solid #444; vertical-align:top; }
    table.data-table th { position:sticky; top:0; background:#2d3f4d; z-index:2; font-weight:600; letter-spacing:.5px; }
    table.data-table tbody tr:nth-child(even){ background:#1e2a33; }
    .truncate { max-width:300px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .row-expand { cursor:pointer; color:#87CEFA; font-size:.6rem; }
        .record { background:#1b2733; border:1px solid #3d4c55; border-radius:12px; padding:16px 18px; display:flex; flex-direction:column; gap:10px; position:relative; }
        .record h3 { margin:0; font-size:.95rem; font-weight:600; }
        .badge-row { display:flex; flex-wrap:wrap; gap:6px; }
        .badge { background:#2d3f4d; color:#cfe9ff; font-size:.6rem; padding:4px 8px; border-radius:100px; letter-spacing:.5px; text-transform:uppercase; }
        .json-view { font-family:Consolas,Monaco,monospace; font-size:.7rem; background:#111a22; border:1px solid #2c3a44; border-radius:8px; padding:10px 12px; white-space:pre; overflow:auto; max-height:240px; }
        .empty { text-align:center; font-style:italic; color:#ccc; }
        .error { color:#ff7b7b; font-weight:600; }
        .spinner { width:18px; height:18px; border:3px solid rgba(255,255,255,.2); border-top-color:#7ec8ff; border-radius:50%; animation:spin 1s linear infinite; }
        .inline { display:inline-flex; align-items:center; gap:10px; }
        @keyframes spin { to { transform:rotate(360deg);} }
        .toolbar { display:flex; gap:10px; flex-wrap:wrap; }
        .filter-box { background:#222; border:2px solid #555; border-radius:10px; padding:8px 12px; display:flex; gap:10px; }
        .filter-box input { border:none; background:transparent; padding:0; font-size:.75rem; min-width:160px; }
        .filter-box input:focus { outline:none; }
        .copy-btn { position:absolute; top:10px; right:10px; font-size:.55rem; padding:4px 8px; background:#2d3f4d; color:#fff; border:none; border-radius:6px; cursor:pointer; }
        .copy-btn:hover { background:#3d5566; }
        @media (max-width:800px){ .panel { padding:22px 20px; } h1 { font-size:1.7rem; } }
    </style>
</head>
<body>
    <div class="shell">
        <div class="panel">
            <h1>Documents & Manifests</h1>
            <p class="sub">Default view lists documents from the database with basic metadata & chunk counts. Select a row or enter an ID to view its <code>manifest.jsonl</code> records from local storage (.data/uploads/metadata/&lt;doc_id&gt;/manifest.jsonl).</p>
            <form id="queryForm" class="query" autocomplete="off" style="margin-bottom:10px;">
                <div>
                    <label for="docId">Document ID</label>
                    <input type="number" id="docId" name="docId" min="1" required placeholder="e.g., 12" />
                </div>
                <div>
                    <label for="filter">Text Filter (client)</label>
                    <input type="text" id="filter" placeholder="Type to filter records" />
                </div>
                <div style="display:flex; gap:8px;">
                    <button type="submit" id="fetchBtn">Fetch</button>
                    <button type="button" class="secondary" id="clearBtn">Clear</button>
                </div>
            </form>
            <div class="status" id="status"></div>
        </div>

        <div class="panel" id="documentsPanel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px;flex-wrap:wrap;">
                <h2 style="font-size:1.2rem;margin:0;">Documents</h2>
                <div style="display:flex;gap:8px;align-items:center;">
                    <label style="font-size:.6rem;letter-spacing:1px;">Limit</label>
                    <input type="number" id="docLimit" value="100" min="10" max="500" style="width:90px;" />
                    <button type="button" id="refreshDocs" style="padding:8px 14px;font-size:.7rem;">Refresh</button>
                </div>
            </div>
            <div class="table-wrapper" id="documentsTableWrapper" style="display:block;"></div>
            <div class="status" id="docStatus"></div>
        </div>

        <div class="panel results" id="resultsPanel" style="display:none;margin-top:-10px;">
            <div class="view-toggles">
                <button type="button" id="cardsMode" class="active">Records</button>
                <button type="button" id="tableMode">Table</button>
                <button type="button" id="backToDocs" style="margin-left:auto;">Back to Documents</button>
            </div>
            <div class="meta-grid" id="metaGrid"></div>
            <div class="records" id="records" style="display:block;"></div>
            <div class="table-wrapper" id="tableWrapper" style="display:none;"></div>
        </div>
    </div>

    <script>
        const qForm = document.getElementById('queryForm');
        const docIdInput = document.getElementById('docId');
        const filterInput = document.getElementById('filter');
        const statusEl = document.getElementById('status');
        const metaGrid = document.getElementById('metaGrid');
    const recordsEl = document.getElementById('records');
    const tableWrapper = document.getElementById('tableWrapper');
    const cardsModeBtn = document.getElementById('cardsMode');
    const tableModeBtn = document.getElementById('tableMode');
    const backToDocsBtn = document.getElementById('backToDocs');
        const resultsPanel = document.getElementById('resultsPanel');
    const documentsPanel = document.getElementById('documentsPanel');
    const documentsTableWrapper = document.getElementById('documentsTableWrapper');
    const docStatus = document.getElementById('docStatus');
    const refreshDocsBtn = document.getElementById('refreshDocs');
    const docLimitInput = document.getElementById('docLimit');
        const clearBtn = document.getElementById('clearBtn');
        const fetchBtn = document.getElementById('fetchBtn');
        let rawRecords = []; // full list

        function esc(v){
            return String(v ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        }

        function setStatus(msg, isError=false){
            statusEl.innerHTML = msg ? `<span class="${isError?'error':''}">${esc(msg)}</span>` : '';
        }

        function spinner(){
            setStatus(`<span class='inline'><span class='spinner'></span> Loading...</span>`);
        }

        function buildMetaCard(k, v){
            return `<div class="kv"><span class="k">${esc(k)}</span><span class="v">${esc(v)}</span></div>`;
        }

        function populateMeta(docId, arr){
            metaGrid.innerHTML = '';
            if (!arr.length){ return; }
            // Use the most recent record (last line) for top-level summary
            const last = arr[arr.length-1];
            const keys = ["doc_id","title","sha256","bytes","content_type","created_at","doc_type","jurisdiction"];
            keys.forEach(k=>{ if(k in last) metaGrid.insertAdjacentHTML('beforeend', buildMetaCard(k,last[k])); });
        }

        function filteredRecords(){
            const term = filterInput.value.trim().toLowerCase();
            return term ? rawRecords.filter(r => JSON.stringify(r).toLowerCase().includes(term)) : rawRecords;
        }

        function renderRecords(){
            const list = filteredRecords();
            if(cardsModeBtn.classList.contains('active')){
                if(!list.length){ recordsEl.innerHTML = '<div class="empty">No manifest entries match.</div>'; return; }
                recordsEl.innerHTML = list.map((rec, idx) => {
                    const label = rec.title || `Record ${idx+1}`;
                    const badges = [];
                    if(rec.doc_type) badges.push(`<span class='badge'>${esc(rec.doc_type)}</span>`);
                    if(rec.jurisdiction) badges.push(`<span class='badge'>${esc(rec.jurisdiction)}</span>`);
                    return `<div class='record'>
                        <button class='copy-btn' data-copy='${esc(rec.sha256 || '')}' ${rec.sha256?"":"disabled"}>Copy SHA</button>
                        <h3>${esc(label)}</h3>
                        <div class='badge-row'>${badges.join('')}</div>
                        <div class='json-view'>${esc(JSON.stringify(rec,null,2))}</div>
                    </div>`;
                }).join('');
                attachCopyHandlers();
            } else {
                renderTable(list);
            }
        }

        function renderTable(list){
            if(!list.length){ tableWrapper.innerHTML = '<div class="empty">No manifest entries match.</div>'; return; }
            const columns = ["doc_id","title","doc_type","jurisdiction","bytes","content_type","sha256","created_at"];
            let html = '<table class="data-table"><thead><tr>' + columns.map(c=>`<th>${esc(c)}</th>`).join('') + '</tr></thead><tbody>';
            html += list.map(r => '<tr>'+ columns.map(c => {
                let val = r[c];
                if(val == null) val='';
                let display = String(val);
                if(display.length>140) display = display.slice(0,140)+'…';
                return `<td class="${display!==String(val)?'truncate':''}" title="${esc(String(val))}">${esc(display)}</td>`;
            }).join('') + '</tr>').join('');
            html += '</tbody></table>';
            tableWrapper.innerHTML = html;
        }

        function attachCopyHandlers(){
            recordsEl.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const val = btn.getAttribute('data-copy');
                    if(!val) return;
                    navigator.clipboard.writeText(val).then(()=>{
                        btn.textContent = 'Copied';
                        setTimeout(()=> btn.textContent = 'Copy SHA', 1500);
                    });
                });
            });
        }

        function fetchDocuments(){
            const limit = Math.max(10, Math.min(500, parseInt(docLimitInput.value,10)||100));
            docStatus.innerHTML = `<span class='inline'><span class='spinner'></span> Loading...</span>`;
            fetch(`/api/documents?limit=${limit}`)
              .then(r=>r.json())
              .then(data => {
                  const docs = Array.isArray(data.documents) ? data.documents : [];
                  docStatus.textContent = docs.length ? `Loaded ${docs.length} document(s).` : 'No documents.';
                  renderDocumentsTable(docs);
              })
              .catch(err => { docStatus.innerHTML = `<span class='error'>Failed: ${esc(err.message)}</span>`; });
        }

        function renderDocumentsTable(docs){
            if(!docs.length){ documentsTableWrapper.innerHTML = '<div class="empty">No documents found.</div>'; return; }
            const cols = ["doc_id","title","doc_type","jurisdiction","chunk_count","created_at","sha256"];
            let html = '<table class="data-table"><thead><tr>'+cols.map(c=>`<th>${esc(c)}</th>`).join('')+'</tr></thead><tbody>';
            html += docs.map(d=>'<tr data-doc="'+esc(d.doc_id)+'">'+cols.map(c=>{
                let v=d[c]; if(v==null) v=''; let disp=String(v); if(disp.length>120) disp=disp.slice(0,120)+'…';
                return `<td class="${disp!==String(v)?'truncate':''}" title="${esc(String(v))}">${esc(disp)}</td>`;
            }).join('')+'</tr>').join('');
            html+='</tbody></table>';
            documentsTableWrapper.innerHTML=html;
            documentsTableWrapper.querySelectorAll('tbody tr').forEach(tr=>{
                tr.addEventListener('click',()=>{
                    const did = tr.getAttribute('data-doc');
                    if(did){ docIdInput.value = did; showManifestView(); fetchManifest(did); }
                });
            });
        }

        function showManifestView(){
            documentsPanel.style.display='none';
            resultsPanel.style.display='block';
        }

        function showDocuments(){
            resultsPanel.style.display='none';
            documentsPanel.style.display='block';
        }

        function fetchManifest(docId){
            spinner();
            fetch(`/api/manifest?doc_id=${encodeURIComponent(docId)}`)
                .then(r => r.json())
                .then(data => {
                    if(data.error){ setStatus(data.error, true); resultsPanel.style.display='none'; return; }
                    rawRecords = Array.isArray(data.manifest) ? data.manifest : [];
                    setStatus(rawRecords.length ? `Loaded ${rawRecords.length} record(s).` : 'No manifest entries.');
                    populateMeta(docId, rawRecords);
                    renderRecords();
                    resultsPanel.style.display='block';
                })
                .catch(err => {
                    setStatus('Failed to load manifest: '+ err.message, true);
                    resultsPanel.style.display='none';
                });
        }

    filterInput.addEventListener('input', () => renderRecords());
    cardsModeBtn.addEventListener('click', () => { if(cardsModeBtn.classList.contains('active')) return; cardsModeBtn.classList.add('active'); tableModeBtn.classList.remove('active'); recordsEl.style.display='block'; tableWrapper.style.display='none'; renderRecords(); });
    tableModeBtn.addEventListener('click', () => { if(tableModeBtn.classList.contains('active')) return; tableModeBtn.classList.add('active'); cardsModeBtn.classList.remove('active'); recordsEl.style.display='none'; tableWrapper.style.display='block'; renderRecords(); });

        qForm.addEventListener('submit', e => {
            e.preventDefault();
            const id = docIdInput.value.trim();
            if(!id){ setStatus('Document ID required', true); return; }
            fetchManifest(id);
        });

        clearBtn.addEventListener('click', () => {
            docIdInput.value='';
            filterInput.value='';
            rawRecords=[]; metaGrid.innerHTML=''; recordsEl.innerHTML=''; resultsPanel.style.display='none'; setStatus('');
        });

    backToDocsBtn.addEventListener('click', showDocuments);
    refreshDocsBtn.addEventListener('click', fetchDocuments);
    docLimitInput.addEventListener('change', fetchDocuments);

    // Initial load: list documents unless doc_id pre-specified
    const params = new URLSearchParams(window.location.search);
    const qsId = params.get('doc_id');
    if(qsId){ docIdInput.value = qsId; showManifestView(); fetchManifest(qsId); }
    else { fetchDocuments(); }
    </script>
</body>
</html>
