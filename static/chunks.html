<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Chunks Viewer</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Rounded','SF Pro Display',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:#001122;color:#fff;min-height:100vh;padding:28px;display:flex;flex-direction:column;align-items:center;gap:28px}
        .shell{width:100%;max-width:1400px;display:flex;flex-direction:column;gap:26px}
        .panel{background:#333;border-radius:20px;padding:26px 32px;box-shadow:0 18px 50px rgba(0,0,0,.5);display:flex;flex-direction:column;gap:20px}
        h1{font-size:2.1rem;font-weight:500;text-shadow:0 4px 8px rgba(0,0,0,.5);margin:0}
        p.sub{font-size:.8rem;color:#ccc;font-style:italic;line-height:1.5;margin:0}
        a{color:#87CEFA;text-decoration:none}a:hover{text-decoration:underline}
        form.query{display:flex;flex-wrap:wrap;gap:14px;align-items:flex-end}
        form.query>div{display:flex;flex-direction:column;gap:6px}
        label{font-size:.7rem;text-transform:uppercase;letter-spacing:1px;color:#ccc}
        input[type=number],input[type=text]{background:#222;border:2px solid #555;border-radius:10px;padding:10px 14px;color:#fff;font-family:inherit;min-width:140px}
        input:focus{outline:none;border-color:#7ec8ff;box-shadow:0 0 0 3px rgba(126,200,255,.15)}
        button{background:#7ec8ff;color:#001122;border:none;padding:10px 18px;border-radius:10px;font-weight:600;cursor:pointer;font-size:.85rem;letter-spacing:1px;transition:.25s;box-shadow:0 8px 18px rgba(126,200,255,.25)}
        button:hover{background:#6bb8ff;transform:translateY(-2px)}
        button:active{transform:translateY(0)}
        button.secondary{background:rgba(255,102,102,.45);color:#fff;box-shadow:none}
        button.secondary:hover{background:rgba(255,102,102,.6)}
        .status{font-size:.75rem;color:#ccc;min-height:18px}
    .results{display:flex;flex-direction:column;gap:22px}
    .view-toggles{display:flex;gap:10px;flex-wrap:wrap}
    .view-toggles button{background:#2d3f4d;color:#cfe9ff;box-shadow:none;padding:8px 14px;font-size:.65rem}
    .view-toggles button.active{background:#7ec8ff;color:#001122}
        .summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px}
        .kv{background:#222;border:2px solid #555;border-radius:12px;padding:10px 12px;display:flex;flex-direction:column;gap:4px}
        .kv span.k{font-size:.6rem;text-transform:uppercase;letter-spacing:1px;color:#999}
        .kv span.v{font-size:.8rem;word-break:break-word}
    .chunks{display:flex;flex-direction:column;gap:14px;max-height:60vh;overflow:auto}
    .table-wrapper{background:#222;border:2px solid #555;border-radius:16px;padding:14px 18px;max-height:60vh;overflow:auto}
    table.data-table{width:100%;border-collapse:collapse;font-size:.65rem}
    table.data-table th,table.data-table td{padding:6px 8px;text-align:left;border:1px solid #444;vertical-align:top}
    table.data-table th{position:sticky;top:0;background:#2d3f4d;z-index:2;font-weight:600;letter-spacing:.5px}
    table.data-table tbody tr:nth-child(even){background:#1e2a33}
    .truncate{max-width:420px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .chunk{background:#1b2733;border:1px solid #3d4c55;border-radius:14px;padding:16px 18px;display:flex;flex-direction:column;gap:10px;position:relative}
        .chunk h3{margin:0;font-size:.85rem;font-weight:600}
        .meta-row{display:flex;flex-wrap:wrap;gap:6px;font-size:.55rem;letter-spacing:.5px}
        .tag{background:#2d3f4d;color:#cfe9ff;font-size:.55rem;padding:4px 8px;border-radius:100px;text-transform:uppercase}
        .text{font-family:Consolas,Monaco,monospace;font-size:.7rem;line-height:1.35;white-space:pre-wrap;word-break:break-word;max-height:220px;overflow:hidden;position:relative}
        .text.expanded{max-height:none}
        .expand-btn{position:absolute;bottom:0;right:0;background:linear-gradient(90deg,rgba(0,0,0,0),#1b2733 60%);padding:4px 8px;font-size:.55rem;border:none;color:#87CEFA;cursor:pointer}
        .expand-btn:hover{text-decoration:underline}
        .toolbar{display:flex;flex-wrap:wrap;gap:10px}
        .toolbar input{background:#222;border:2px solid #555;border-radius:10px;padding:8px 10px;color:#fff;font-size:.75rem;min-width:220px}
        .toolbar input:focus{outline:none;border-color:#7ec8ff;box-shadow:0 0 0 3px rgba(126,200,255,.15)}
        .pagination{display:flex;align-items:center;gap:12px;font-size:.7rem;flex-wrap:wrap}
        .pagination button{padding:6px 12px;font-size:.65rem}
        .empty{text-align:center;font-style:italic;color:#ccc}
        .spinner{width:18px;height:18px;border:3px solid rgba(255,255,255,.2);border-top-color:#7ec8ff;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        @media (max-width:900px){.panel{padding:22px 20px}h1{font-size:1.7rem}}
    </style>
</head>
<body>
    <div class="shell">
        <div class="panel">
            <h1>Chunks Viewer</h1>
            <p class="sub">Inspect chunk records stored in the database. Provide a document ID to list its chunks via <code>/api/chunks?doc_id=&lt;id&gt;</code>. Text is truncated; expand individual chunks to view full content.</p>
            <form id="queryForm" class="query" autocomplete="off">
                <div>
                    <label for="docId">Document ID</label>
                    <input type="number" id="docId" min="1" placeholder="e.g., 12" required />
                </div>
                <div>
                    <label for="filter">Text Filter (client)</label>
                    <input type="text" id="filter" placeholder="filter text..." />
                </div>
                <div>
                    <label for="pageSize">Page Size</label>
                    <input type="number" id="pageSize" min="5" max="200" value="25" />
                </div>
                <div style="display:flex;gap:8px;">
                    <button type="submit" id="fetchBtn">Fetch</button>
                    <button type="button" class="secondary" id="clearBtn">Clear</button>
                </div>
            </form>
            <div class="toolbar">
                <input type="text" id="sectionFilter" placeholder="filter by section (contains)" />
                <input type="text" id="indexFilter" placeholder="filter by chunk index (exact)" />
            </div>
            <div class="status" id="status"></div>
        </div>

        <div class="panel results" id="resultsPanel" style="display:none;">
            <div class="view-toggles">
                <button type="button" id="cardsMode" class="active">Cards</button>
                <button type="button" id="tableMode">Table</button>
            </div>
            <div class="summary" id="summary"></div>
            <div class="chunks" id="chunks" style="display:block;"></div>
            <div class="table-wrapper" id="tableWrapper" style="display:none;"></div>
            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <script>
        const form = document.getElementById('queryForm');
        const docIdInput = document.getElementById('docId');
        const filterInput = document.getElementById('filter');
        const sectionFilter = document.getElementById('sectionFilter');
        const indexFilter = document.getElementById('indexFilter');
        const pageSizeInput = document.getElementById('pageSize');
        const statusEl = document.getElementById('status');
        const summaryEl = document.getElementById('summary');
    const chunksEl = document.getElementById('chunks');
    const tableWrapper = document.getElementById('tableWrapper');
    const cardsModeBtn = document.getElementById('cardsMode');
    const tableModeBtn = document.getElementById('tableMode');
        const paginationEl = document.getElementById('pagination');
        const clearBtn = document.getElementById('clearBtn');
        const resultsPanel = document.getElementById('resultsPanel');

        let rawChunks = [];
        let currentPage = 1;

        function esc(v){return String(v??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
        function setStatus(msg,isErr=false){statusEl.innerHTML = msg?`<span style="${isErr?'color:#ff7b7b;font-weight:600;':''}">${esc(msg)}</span>`:'';}
        function spinner(){setStatus(`<span style='display:inline-flex;align-items:center;gap:8px;'><span class="spinner"></span> Loading...</span>`);}

        function fetchChunks(docId){
            spinner();
            fetch(`/api/chunks?doc_id=${encodeURIComponent(docId)}`)
                .then(r=>r.json())
                .then(data=>{
                    if(data.error){ setStatus(data.error,true); resultsPanel.style.display='none'; return; }
                    rawChunks = Array.isArray(data.chunks)?data.chunks:[];
                    setStatus(rawChunks.length?`Loaded ${rawChunks.length} chunk(s).`:'No chunks.');
                    buildSummary(data);
                    currentPage=1;
                    render();
                    resultsPanel.style.display='block';
                })
                .catch(err=>{ setStatus('Failed to load chunks: '+err.message,true); resultsPanel.style.display='none'; });
        }

        function buildSummary(apiData){
            summaryEl.innerHTML='';
            if(!rawChunks.length) return;
            const last = rawChunks[rawChunks.length-1];
            const meta = {
                doc_id: apiData.doc_id,
                total_chunks: rawChunks.length,
                first_chunk_id: rawChunks[0]?.chunk_id,
                last_chunk_id: last?.chunk_id,
                token_version: last?.tok_ver,
                segment_version: last?.seg_ver
            };
            Object.entries(meta).forEach(([k,v])=>{
                summaryEl.insertAdjacentHTML('beforeend', `<div class="kv"><span class="k">${esc(k)}</span><span class="v">${esc(v)}</span></div>`);
            });
        }

        function applyFilters(list){
            const t = filterInput.value.trim().toLowerCase();
            const s = sectionFilter.value.trim().toLowerCase();
            const idx = indexFilter.value.trim();
            return list.filter(c=>{
                if(t && !JSON.stringify(c).toLowerCase().includes(t)) return false;
                if(s && !(c.section||'').toLowerCase().includes(s)) return false;
                if(idx && String(c.chunk_index) !== idx) return false;
                return true;
            });
        }

        function paginate(list,page,pageSize){
            const start=(page-1)*pageSize; return list.slice(start,start+pageSize);
        }

        function render(){
            const filtered = applyFilters(rawChunks);
            const pageSize = Math.max(5, Math.min(200, parseInt(pageSizeInput.value,10)||25));
            const pageCount = Math.max(1, Math.ceil(filtered.length / pageSize));
            if(currentPage>pageCount) currentPage=pageCount;
            const pageItems = paginate(filtered,currentPage,pageSize);

            if(!filtered.length){ chunksEl.innerHTML='<div class="empty">No chunks match filters.</div>'; paginationEl.innerHTML=''; return; }

            if(cardsModeBtn.classList.contains('active')){
                chunksEl.innerHTML = pageItems.map(ch => renderChunk(ch)).join('');
                tableWrapper.innerHTML='';
                attachExpandHandlers();
            } else {
                renderTable(filtered,pageSize,pageCount);
            }
            buildPagination(pageCount);
        }

        function renderTable(filtered,pageSize,pageCount){
            const pageSizeVal = Math.max(5, Math.min(200, parseInt(pageSizeInput.value,10)||25));
            const start=(currentPage-1)*pageSizeVal;
            const subset=filtered.slice(start,start+pageSizeVal);
            if(!subset.length){ tableWrapper.innerHTML='<div class="empty">No chunks match filters.</div>'; return; }
            const columns=["chunk_id","chunk_index","token_count","tok_ver","seg_ver","text"];
            let html='<table class="data-table"><thead><tr>'+columns.map(c=>`<th>${esc(c)}</th>`).join('')+'</tr></thead><tbody>';
            html+= subset.map(r=>'<tr>'+columns.map(c=>{
                let val=r[c]; if(val==null) val=''; let display=String(val); if(c==='text' && display.length>240) display=display.slice(0,240)+'…';
                return `<td class="${display!==String(val)?'truncate':''}" title="${esc(String(val))}">${esc(display)}</td>`;
            }).join('')+'</tr>').join('');
            html+='</tbody></table>';
            tableWrapper.innerHTML=html;
        }

        function renderChunk(ch){
            const truncated = (ch.text||'').length>800 ? (ch.text.slice(0,800)+'…') : ch.text;
            const needsExpand = truncated !== ch.text;
            const metaTags = [];
            metaTags.push(`<span class='tag'>Idx ${esc(ch.chunk_index)}</span>`);
            if(ch.token_count!=null) metaTags.push(`<span class='tag'>Tok ${esc(ch.token_count)}</span>`);
            if(ch.section) metaTags.push(`<span class='tag'>Sec</span>`);
            return `<div class='chunk' data-chunk='${esc(ch.chunk_id)}'>
                <h3>Chunk ${esc(ch.chunk_id)}</h3>
                <div class='meta-row'>${metaTags.join('')}</div>
                <div class='text${needsExpand?'':' expanded'}' data-full='${esc(ch.text||'')}' data-trunc='${esc(truncated)}'>${esc(truncated)}</div>
                ${needsExpand?'<button class="expand-btn" type="button">Expand</button>':''}
            </div>`;
        }

        function attachExpandHandlers(){
            chunksEl.querySelectorAll('.expand-btn').forEach(btn=>{
                btn.addEventListener('click',()=>{
                    const wrapper = btn.closest('.chunk');
                    const textDiv = wrapper.querySelector('.text');
                    if(!textDiv) return;
                    if(textDiv.classList.contains('expanded')){
                        textDiv.classList.remove('expanded');
                        textDiv.textContent = textDiv.getAttribute('data-trunc');
                        btn.textContent='Expand';
                    } else {
                        textDiv.classList.add('expanded');
                        textDiv.textContent = textDiv.getAttribute('data-full');
                        btn.textContent='Collapse';
                    }
                });
            });
        }

        function buildPagination(pageCount){
            paginationEl.innerHTML='';
            if(pageCount<=1) return;
            const makeBtn=(label,disabled,on)=>{const b=document.createElement('button');b.textContent=label;b.disabled=disabled;b.addEventListener('click',on);return b;};
            paginationEl.appendChild(makeBtn('Prev',currentPage===1,()=>{currentPage--;render();}));
            paginationEl.insertAdjacentHTML('beforeend', `<span>Page ${currentPage} / ${pageCount}</span>`);
            paginationEl.appendChild(makeBtn('Next',currentPage===pageCount,()=>{currentPage++;render();}));
        }

        form.addEventListener('submit',e=>{e.preventDefault(); const id=docIdInput.value.trim(); if(!id){setStatus('Document ID required',true);return;} fetchChunks(id);});
        clearBtn.addEventListener('click',()=>{docIdInput.value='';filterInput.value='';sectionFilter.value='';indexFilter.value='';rawChunks=[];resultsPanel.style.display='none';setStatus('');});
    [filterInput, sectionFilter, indexFilter, pageSizeInput].forEach(inp=>inp.addEventListener('input',()=>{currentPage=1;render();}));
    cardsModeBtn.addEventListener('click',()=>{ if(cardsModeBtn.classList.contains('active')) return; cardsModeBtn.classList.add('active'); tableModeBtn.classList.remove('active'); chunksEl.style.display='flex'; tableWrapper.style.display='none'; render(); });
    tableModeBtn.addEventListener('click',()=>{ if(tableModeBtn.classList.contains('active')) return; tableModeBtn.classList.add('active'); cardsModeBtn.classList.remove('active'); chunksEl.style.display='none'; tableWrapper.style.display='block'; render(); });

        const params = new URLSearchParams(window.location.search); const qsId = params.get('doc_id'); if(qsId){ docIdInput.value=qsId; fetchChunks(qsId); }
    </script>
</body>
</html>
